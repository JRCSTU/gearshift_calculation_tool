

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gearshift.core.model.calculateShiftpointsNdvFullPC.corrections &mdash; GEARSHIFT TOOL 1.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home" alt="Documentation Home"> GEARSHIFT TOOL
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html#quick-start">Quick-Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../model.html">Gearshift Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../api.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">GEARSHIFT TOOL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../../../gearshift.html">gearshift</a> &raquo;</li>
        
          <li><a href="../../../core.html">gearshift.core</a> &raquo;</li>
        
          <li><a href="../calculateShiftpointsNdvFullPC.html">gearshift.core.model.calculateShiftpointsNdvFullPC</a> &raquo;</li>
        
      <li>gearshift.core.model.calculateShiftpointsNdvFullPC.corrections</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gearshift.core.model.calculateShiftpointsNdvFullPC.corrections</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2015-2020 European Commission (JRC);</span>
<span class="c1"># Licensed under the EUPL (the &#39;Licence&#39;);</span>
<span class="c1"># You may not use this work except in compliance with the Licence.</span>
<span class="c1"># You may obtain a copy of the Licence at: http://ec.europa.eu/idabc/eupl</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">It provides the corrections defined in section 4 of the Sub-Annex 2 from Annex XXI from the</span>
<span class="sd">COMMISSION REGULATION (EU) 2017/1151.</span>

<span class="sd">Docstrings should provide sufficient understanding for any individual function.</span>

<span class="sd">Sub-Modules:</span>

<span class="sd">.. currentmodule:: gearshift.core.model.calculateShiftpointsNdvFullPC.corrections</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :nosignatures:</span>
<span class="sd">    :toctree: calculateShiftpointsNdvFullPC/corrections/</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">regex</span> <span class="k">as</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<div class="viewcode-block" id="appendCorrectionCells"><a class="viewcode-back" href="../../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.html#gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.appendCorrectionCells">[docs]</a><span class="k">def</span> <span class="nf">appendCorrectionCells</span><span class="p">(</span>
    <span class="n">CorrectionsCells</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">InitialGearsPrev</span><span class="p">,</span> <span class="n">correctionType</span><span class="p">,</span> <span class="n">correctionNbr</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     This function is just for debugging of gear corrections.</span>
<span class="sd">     It extends a cell array of gear correction strings by the current corrections and the resulting corrected gears.</span>
<span class="sd">     Each gear correction is indicated by a string combining correction type and number.</span>
<span class="sd">     If eg gear 2 is corrected to gear 3 by correction &#39;4a&#39; during the first iteration then the gear correction string</span>
<span class="sd">     will be extended by &#39; 4a1 3&#39;.</span>
<span class="sd">     If eg gear 2 is not corrected then the gear correction string will be extended by &#39; --- 2&#39;.</span>

<span class="sd">    :param CorrectionsCells:</span>
<span class="sd">        A cell array of gear correction strings BEFORE the current correction</span>
<span class="sd">    :type CorrectionsCells: numpy.array</span>

<span class="sd">    :param InitialGears:</span>
<span class="sd">        A cell array of gear numbers AFTER the current correction</span>
<span class="sd">    :type InitialGears: numpy.array</span>

<span class="sd">    :param InitialGearsPrev:</span>
<span class="sd">        A cell array of gear numbers BEFORE the current correction</span>
<span class="sd">    :type InitialGearsPrev: numpy.array</span>

<span class="sd">    :param InitialGearsPrev:</span>
<span class="sd">        A cell array of gear numbers BEFORE the current correction</span>
<span class="sd">    :type InitialGearsPrev: numpy.array</span>

<span class="sd">    :param correctionType:</span>
<span class="sd">        A string indicating the type of the current correction</span>
<span class="sd">        eg &#39;4c&#39;</span>
<span class="sd">    :type correctionType: String</span>

<span class="sd">    :param correctionNbr:</span>
<span class="sd">        A number indicating the iteration of the current correction</span>
<span class="sd">    :type correctionNbr: Integer</span>

<span class="sd">    :returns:</span>
<span class="sd">        - CorrectionsCells (:py:class:`numpy.array`):</span>
<span class="sd">            A cell array of gear correction strings AFTER the current correction.</span>
<span class="sd">            For example:</span>

<span class="sd">            &#39;4 --- 4 4b1 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2 --- 2&#39;</span>

<span class="sd">            &#39;4 --- 4 4b1 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3&#39;</span>

<span class="sd">            &#39;5 --- 5 4b1 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 4b2 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3 --- 3&#39;</span>

<span class="sd">            &#39;5 --- 5 --- 5 4c1 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 4g2 3 --- 3 --- 3 --- 3 --- 3&#39;</span>

<span class="sd">            &#39;5 --- 5 --- 5 4c1 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 --- 4 4g2 3 --- 3 --- 3 --- 3 --- 3&#39;</span>

<span class="sd">        - InitialGearsPrev (:py:class:`numpy.array`):</span>
<span class="sd">            A cell array of gear numbers AFTER current correction i.e. before next correction</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">InitialGearsCells</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)))))</span>
    <span class="n">InitialGearsCells</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">InitialGearsCells</span><span class="p">]</span>
    <span class="n">InitialGearsCells</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">InitialGearsCells</span><span class="p">]</span>
    <span class="n">InitialGearsCells</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">InitialGearsCells</span><span class="p">]</span>
    <span class="n">InitialGearsCells</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; *&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">InitialGearsCells</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">correctionNbr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">CorrectionsCellsF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">InitialGearsCells</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">BlankCells</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">InitialGearsCells</span><span class="p">]</span>
        <span class="n">ChangedGearsCells</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;---&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">InitialGearsCells</span><span class="p">]</span>
        <span class="n">ChangedGearsCells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ChangedGearsCells</span><span class="p">)</span>
        <span class="n">ChangedGearsCells</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InitialGears</span> <span class="o">!=</span> <span class="n">InitialGearsPrev</span><span class="p">)</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">correctionType</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">correctionNbr</span><span class="p">)</span>
        <span class="n">ChangedGearsCells</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">InitialGearsPrev</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;---&quot;</span>
        <span class="n">CorrectionsCellsF</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">CorrectionsCells</span><span class="p">)):</span>
            <span class="n">CorrectionsCellsF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">CorrectionsCells</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">BlankCells</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ChangedGearsCells</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">BlankCells</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">InitialGearsCells</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="p">)</span>

    <span class="n">InitialGearsPrev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">CorrectionsCellsF</span><span class="p">),</span> <span class="n">InitialGearsPrev</span></div>


<span class="k">def</span> <span class="nf">_my_cummin</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">min_val</span><span class="p">):</span>
            <span class="n">min_val</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_val</span><span class="p">:</span>
            <span class="n">min_val</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">M</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_val</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">M</span>


<span class="k">def</span> <span class="nf">_sub2ind</span><span class="p">(</span><span class="n">array_shape</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">array_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span>
    <span class="k">return</span> <span class="n">ind</span>


<div class="viewcode-block" id="applyCorrection4b"><a class="viewcode-back" href="../../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.html#gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.applyCorrection4b">[docs]</a><span class="k">def</span> <span class="nf">applyCorrection4b</span><span class="p">(</span>
    <span class="n">InitialGears</span><span class="p">,</span>
    <span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">,</span>
    <span class="n">Corr4bToBeDoneAfterCorr4d</span><span class="p">,</span>
    <span class="n">PhaseValues</span><span class="p">,</span>
    <span class="n">PhaseStarts</span><span class="p">,</span>
    <span class="n">PhaseEnds</span><span class="p">,</span>
    <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">,</span>
    <span class="n">PHASE_ACCELERATION</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sub-Annex 2 in section 4.(b) :</span>

<span class="sd">    If a downshift is required during an acceleration phase</span>
<span class="sd">    or at the beginning of the acceleration phase</span>
<span class="sd">    the gear required during this downshift shall be noted (i_DS).</span>

<span class="sd">    The starting point of a correction procedure is defined by either</span>
<span class="sd">    the last previous second when i_DS was identified</span>
<span class="sd">    or by the starting point of the acceleration phase,</span>
<span class="sd">    if all time samples before have gears &gt; i_DS.</span>

<span class="sd">    The highest gear of the time samples before the downshift</span>
<span class="sd">    determines the reference gear i_ref for the downshift.</span>
<span class="sd">    A downshift where i_DS = i_ref - 1</span>
<span class="sd">    is referred to as a one step downshift,</span>
<span class="sd">    a downshift where i_DS = i_ref - 2</span>
<span class="sd">    is referred to as a two step downshift,</span>
<span class="sd">    a downshift where i_DS = i_ref â€“ 3</span>
<span class="sd">    is referred to as a three step downshift.</span>

<span class="sd">    Visualization of rules implemented:</span>

<span class="sd">    initial gear sequence:</span>

<span class="sd">    .. image:: ../doc/_static/images/initial_gears_correction_4b.*</span>
<span class="sd">    .. image:: ../doc/_static/images/correction_4b_1.*</span>
<span class="sd">    .. image:: ../doc/_static/images/correction_4b_2.*</span>
<span class="sd">    .. image:: ../doc/_static/images/correction_4b_3.*</span>
<span class="sd">    .. image:: ../doc/_static/images/correction_4b_4.*</span>

<span class="sd">    final gear sequence:</span>

<span class="sd">    .. image:: ../doc/_static/images/correction_4b_5.*</span>

<span class="sd">    :param InitialGears:</span>
<span class="sd">        A cell array of gear numbers AFTER the previous correction</span>
<span class="sd">    :type InitialGears: numpy.array</span>

<span class="sd">    :param Corr4bToBeDoneAfterCorr4a:</span>
<span class="sd">        Boolean that check if the correction 4b to be done after correction 4a</span>
<span class="sd">    :type Corr4bToBeDoneAfterCorr4a: bool</span>

<span class="sd">    :param Corr4bToBeDoneAfterCorr4d:</span>
<span class="sd">        Boolean that check if the correction 4b to be done after correction 4d</span>
<span class="sd">    :type Corr4bToBeDoneAfterCorr4d: bool</span>

<span class="sd">    :param PhaseValues:</span>
<span class="sd">        Contains the points of changes phases</span>
<span class="sd">    :type PhaseValues: numpy.array</span>

<span class="sd">    :param PhaseStarts:</span>
<span class="sd">        Contains the points that are start point from a phase</span>
<span class="sd">    :type PhaseStarts: numpy.array</span>

<span class="sd">    :param PhaseEnds:</span>
<span class="sd">        Contains the points that are end point from a phase</span>
<span class="sd">    :type PhaseEnds: numpy.array</span>

<span class="sd">    :param PHASE_ACCELERATION_FROM_STANDSTILL:</span>
<span class="sd">        Acceleration phase following a standstill phase</span>
<span class="sd">    :type PHASE_ACCELERATION_FROM_STANDSTILL: int</span>

<span class="sd">    :param PHASE_ACCELERATION:</span>
<span class="sd">        Acceleration phase</span>
<span class="sd">    :type PHASE_ACCELERATION: int</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: int</span>

<span class="sd">    :returns:</span>
<span class="sd">        - InitialGears (:py:class:`numpy.array`):</span>
<span class="sd">            A cell array of gear numbers AFTER the current correction</span>
<span class="sd">        - Corr4bToBeDoneAfterCorr4a (:py:class:`bool`):</span>
<span class="sd">            Boolean that check if the correction 4b to be done after correction 4a</span>
<span class="sd">        - Corr4bToBeDoneAfterCorr4d (:py:class:`bool`):</span>
<span class="sd">            Boolean that check if the correction 4b to be done after correction 4d</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">AnyAccelerationStarts</span> <span class="o">=</span> <span class="n">PhaseStarts</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">AnyAccelerationEnds</span> <span class="o">=</span> <span class="n">PhaseEnds</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_ACCELERATION_FROM_STANDSTILL</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">AnyAccelerations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">AnyAccelerationStarts</span><span class="p">)):</span>
        <span class="n">AnyAccelerations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">AnyAccelerationStarts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AnyAccelerationEnds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">AnyAccelerations</span><span class="p">:</span>
        <span class="n">gears</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
        <span class="n">gears_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gears</span><span class="p">)</span>

        <span class="n">gears_greater_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gears</span><span class="p">)</span>
        <span class="n">gears_greater_one</span><span class="p">[</span><span class="n">gears_greater_one</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">gears_max_allowed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_my_cummin</span><span class="p">(</span><span class="n">gears_greater_one</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">gears_max_allowed</span> <span class="o">=</span> <span class="n">gears_max_allowed</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gears</span><span class="p">)):</span>
            <span class="n">gears</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">gears</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">gears_max_allowed</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">use_per_gear</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cumulated_use_per_gear</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gear</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gears</span><span class="p">))</span>
            <span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gears</span> <span class="o">==</span> <span class="n">gear</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">use_per_gear</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">cumulated_use_per_gear</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>

        <span class="n">use_per_gear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">use_per_gear</span><span class="p">)</span>
        <span class="n">cumulated_use_per_gear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cumulated_use_per_gear</span><span class="p">)</span>

        <span class="n">size_of_window</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">outdated_use_per_gear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">NoOfGearsFinal</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span> <span class="n">cumulated_use_per_gear</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">outdated_use_per_gear</span> <span class="o">=</span> <span class="n">outdated_use_per_gear</span><span class="p">[</span>
            <span class="p">:,</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">outdated_use_per_gear</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">size_of_window</span>
        <span class="p">]</span>

        <span class="n">nbr_of_use_per_gear</span> <span class="o">=</span> <span class="n">cumulated_use_per_gear</span> <span class="o">-</span> <span class="n">outdated_use_per_gear</span>

        <span class="n">gears_without_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gears</span><span class="p">)</span>
        <span class="n">gears_without_nan</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">gears_without_nan</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_sub2ind</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">nbr_of_use_per_gear</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gears</span><span class="p">)),</span>
                <span class="n">gears_without_nan</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">nbr_of_use_gear</span> <span class="o">=</span> <span class="n">nbr_of_use_per_gear</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">nbr_of_use_per_gear</span><span class="p">),</span> <span class="s2">&quot;F&quot;</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">gears_used_twice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gears</span><span class="p">)</span>
        <span class="n">gears_used_twice</span><span class="p">[</span><span class="n">gears_used_twice</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">gears_used_twice</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nbr_of_use_gear</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">gears_max_allowed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_my_cummin</span><span class="p">(</span><span class="n">gears_used_twice</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gears</span><span class="p">)):</span>
            <span class="n">gears</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">gears</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">gears_max_allowed</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">gears_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gears</span><span class="p">)</span>
        <span class="n">gears_prev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">gears_prev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gears</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">gears_next</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">gears</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">gears</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gears_prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">gears_greater_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gears</span><span class="p">)</span>
        <span class="n">gears_greater_one</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gears</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">final_val_cor4b</span> <span class="o">=</span> <span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>

        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">final_val_cor4b</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gears_greater_one</span> <span class="o">&lt;</span> <span class="n">gears_next</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gears_prev</span> <span class="o">&gt;</span> <span class="n">gears_greater_one</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_val_cor4b</span>

        <span class="n">gears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">gears_orig</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">gears</span>

        <span class="c1"># Annex 2, 5.(b)</span>
        <span class="n">idx_begin</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">idx_begin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">idx_begin</span><span class="p">]</span> <span class="o">-</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">idx_begin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">Corr4bToBeDoneAfterCorr4d</span><span class="p">[</span><span class="n">idx_begin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">,</span> <span class="n">Corr4bToBeDoneAfterCorr4d</span></div>


<div class="viewcode-block" id="applyCorrection4a"><a class="viewcode-back" href="../../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.html#gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.applyCorrection4a">[docs]</a><span class="k">def</span> <span class="nf">applyCorrection4a</span><span class="p">(</span>
    <span class="n">InitialGears</span><span class="p">,</span>
    <span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">,</span>
    <span class="n">PossibleGears</span><span class="p">,</span>
    <span class="n">InAcceleration</span><span class="p">,</span>
    <span class="n">InConstantSpeed</span><span class="p">,</span>
    <span class="n">InAccelerationAnyDuration</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sub-Annex 2 in sectoin 4.(a)</span>

<span class="sd">    If a one step higher gear (n+1) is required for only 1 second</span>
<span class="sd">    and the gears before and after are the same (n),</span>
<span class="sd">    or one of them is one step lower (n-1),</span>
<span class="sd">    gear (n+1) shall be corrected to gear n.</span>

<span class="sd">    :param InitialGears:</span>
<span class="sd">        A cell array of gear numbers AFTER the previous correction</span>
<span class="sd">    :type InitialGears: numpy.array</span>

<span class="sd">    :param Corr4bToBeDoneAfterCorr4a:</span>
<span class="sd">        Boolean that check if the correction 4b to be done after correction 4a</span>
<span class="sd">    :type Corr4bToBeDoneAfterCorr4a: bool</span>

<span class="sd">    :param PossibleGears:</span>
<span class="sd">        The possible gears calculated by each second</span>
<span class="sd">    :type PossibleGears: numpy.array</span>

<span class="sd">    :param InAcceleration:</span>
<span class="sd">        Contains the points that are in acceleration phase as a True</span>
<span class="sd">    :type InAcceleration: boolean numpy.array</span>

<span class="sd">    :param InConstantSpeed:</span>
<span class="sd">        Contains the points that are in constant speed phase as a True</span>
<span class="sd">    :type InConstantSpeed: boolean numpy.array</span>

<span class="sd">    :param InAccelerationAnyDuration:</span>
<span class="sd">         some gear corrections ignore the duration of acceleration phases</span>
<span class="sd">         so save acceleration phases with any duration here</span>
<span class="sd">    :type InAccelerationAnyDuration: boolean numpy.array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - InitialGears (:py:class:`numpy.array`):</span>
<span class="sd">            A cell array of gear numbers AFTER the current correction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

    <span class="n">PreviousInitialGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">))</span>
    <span class="n">PreviousInitialGears</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)):</span>
        <span class="c1"># The gear at the first gear position to be corrected</span>
        <span class="c1"># will be finally corrected after at most two iterations.</span>
        <span class="c1"># So the maximum number of iteration required to correct all gears</span>
        <span class="c1"># will be at most two times the size of the vector of gears.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">PreviousInitialGears</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PreviousInitialGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)</span>

        <span class="n">minPossibleGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">PossibleGears</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">PossibleGears</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># Regulation Annex 2, 4.(a) :</span>
        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># If a one step higher gear (n+1) is required for only 1 second</span>
        <span class="c1"># and the gears before and after are the same (n),</span>
        <span class="c1"># or one of them is one step lower (n-1),</span>
        <span class="c1"># gear (n+1) shall be corrected to gear n.</span>
        <span class="c1"># -----------------------------------------------------------------------</span>

        <span class="n">nextInitialGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="n">upshiftsOneOrTwoGearsOneSec</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">reduce</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">nextInitialGears</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">nextInitialGears</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">nextInitialGears</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="n">upshiftsOneOrTwoGearsOneSec</span><span class="p">:</span>
            <span class="c1"># reduce upshift only if possible for complete duration</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">shift</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">minPossibleGears</span><span class="p">[</span><span class="n">shift</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">shift</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">shift</span><span class="p">]</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">shift</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># 4.(a) continued :</span>
        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># If, during acceleration or constant speed phases</span>
        <span class="c1"># or transitions from constant speed to acceleration</span>
        <span class="c1"># or acceleration to constant speed phases</span>
        <span class="c1"># where these phases only contain upshifts,</span>
        <span class="c1"># a gear is used for only one second,</span>
        <span class="c1"># the gear in the following second shall be corrected to the gear before,</span>
        <span class="c1"># so that a gear is used for at least 2 seconds.</span>
        <span class="c1">#</span>
        <span class="c1"># This requirement shall not be applied to downshifts during an acceleration phase</span>
        <span class="c1"># or if the use of a gear for just one second</span>
        <span class="c1"># follows immediately after such a downshift</span>
        <span class="c1"># or if the downshift occurs right at the beginning of an acceleration phase.</span>
        <span class="c1"># In these cases, the downshifts shall be first corrected</span>
        <span class="c1"># according to paragraph 4.(b) of this annex.</span>
        <span class="c1">#</span>
        <span class="c1"># However, if the gear at the beginning of an acceleration phase</span>
        <span class="c1"># is one step lower than the gear in the previous second</span>
        <span class="c1"># and the gears in the following (up to five) seconds</span>
        <span class="c1"># are the same as the gear in the previous second but followed by a downshift,</span>
        <span class="c1"># so that the application of 4.(c) would correct them</span>
        <span class="c1"># to the same gear as at the beginning of the acceleration phase,</span>
        <span class="c1"># the application of 4.(c) should be performed instead.</span>
        <span class="c1"># -----------------------------------------------------------------------</span>

        <span class="c1"># if a gear is used for a single second but the next gear is lower</span>
        <span class="c1"># then extend this next gear backwards instead of extending the single gear forwards</span>
        <span class="c1"># and so avoid that a higher gear with to less power will used after the single second</span>
        <span class="c1"># eg RRT vehicle 15, trace seconds 909..918 :</span>
        <span class="c1">#   909      918</span>
        <span class="c1">#    v        v</span>
        <span class="c1">#    4345545555    InitialGears</span>
        <span class="c1">#      *&gt;            single extended FORWARD</span>
        <span class="c1">#    4344545555    InitialGears</span>
        <span class="c1">#        &lt;*          single extended BACKWARD</span>
        <span class="c1">#    4344445555    InitialGears</span>
        <span class="c1"># But such a backward extension of the next gear is not allowed</span>
        <span class="c1"># according Heinz Steven (Workshop 2019-02-05)</span>

        <span class="n">InAccelOrConst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">InAcceleration</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">InAccelOrConst</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAcceleration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InConstantSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">singlesInAccelOrConstNextHigher</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">InAccelOrConst</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">singlesInAccelOrConstNextHigher</span><span class="p">,</span>
            <span class="n">reduce</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAccelOrConst</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                                <span class="n">InitialGears</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InAcceleration</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">InitialGears</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InitialGears</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">InitialGears</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">minPossibleGears</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># exclude singles immediately after singles</span>
        <span class="c1"># as later singles will be adjusted to earlier singles</span>
        <span class="n">update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextHigher</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextHigher</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">singlesInAccelOrConstNextHigher</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">InAccelOrConst</span><span class="p">))</span>
        <span class="n">singlesInAccelOrConstNextHigher</span><span class="p">[</span><span class="n">update</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># exclude singles immediately after downshifts</span>
        <span class="n">update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextHigher</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">singlesInAccelOrConstNextHigher</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">InAccelOrConst</span><span class="p">))</span>
        <span class="n">singlesInAccelOrConstNextHigher</span><span class="p">[</span><span class="n">update</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextHigher</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">InitialGears</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextHigher</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextHigher</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="n">singlesInAccelOrConstNextLower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">InAccelOrConst</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">singlesInAccelOrConstNextLower</span><span class="p">,</span>
            <span class="n">reduce</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAccelOrConst</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                                <span class="n">InitialGears</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InAcceleration</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">InitialGears</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InitialGears</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">InitialGears</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">minPossibleGears</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextLower</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">singlesInAccelOrConstNextLower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">InAccelOrConst</span><span class="p">))</span>
        <span class="n">singlesInAccelOrConstNextLower</span><span class="p">[</span><span class="n">update</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextLower</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextLower</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextLower</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">singlesInAccelOrConstNextLower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">InAccelOrConst</span><span class="p">))</span>
            <span class="n">singlesInAccelOrConstNextLower</span><span class="p">[</span><span class="n">update</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">InitialGears</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextLower</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">singlesInAccelOrConstNextLower</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># 4.(a) continued :</span>
        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># Furthermore, if the gear in the first second of an acceleration phase</span>
        <span class="c1"># is the same as the gear in the previous second</span>
        <span class="c1"># and the gear in the following seconds is one step higher,</span>
        <span class="c1"># the gear in the second second of the acceleration phase</span>
        <span class="c1"># shall be replaced by the gear used in the first second of the acceleration phase</span>
        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># The Heinz Steven Tool ignores the length of the acceleration phases here.</span>
        <span class="c1"># So we use InAccelerationAnyDuration instead of InAcceleration here.</span>
        <span class="c1"># HST corrects the gear for eg vehicle_no: 109 time: 1088</span>
        <span class="c1"># where acceleration phase lasts only for time 1087..1088.</span>
        <span class="c1"># -----------------------------------------------------------------------</span>

        <span class="c1"># but this will only be done</span>
        <span class="c1"># if the gear in the first second of the acceleration phase</span>
        <span class="c1"># may not be increased by correction 4b to done after correction 4a</span>

        <span class="n">prevInAccelAnyDur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InAccelerationAnyDuration</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prevPrevNotInAccelAnyDur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">prevInAccelAnyDur</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prevGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prevPrevGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">prevGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prev_Corr4bToBeDoneAfterCorr4a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">prevInAccelAnyDur</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">idx</span><span class="p">,</span>
            <span class="n">reduce</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prevPrevNotInAccelAnyDur</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prevInAccelAnyDur</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAccelerationAnyDuration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prevPrevGears</span> <span class="o">&gt;=</span> <span class="n">prevGears</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prevGears</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">InitialGears</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InitialGears</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">minPossibleGears</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prev_Corr4bToBeDoneAfterCorr4a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># 4.(a) continued :</span>
        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># Gears shall not be skipped during acceleration phases.</span>
        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># In an acceleration phase :</span>
        <span class="c1"># Decrease a gear, if it differs from the previous non-neutral gear by more than 1 step</span>
        <span class="c1"># and the previous gear may not be increased by correction 4b done after correction 4a</span>

        <span class="n">prev_gear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">upshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">gear_decr_possible</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InitialGears</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">minPossibleGears</span><span class="p">)</span>
        <span class="n">prev_Corr4bToBeDoneAfterCorr4a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Corr4bToBeDoneAfterCorr4a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">twoStepUpshiftInAcceleration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">prev_gear</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">twoStepUpshiftInAcceleration</span><span class="p">,</span>
            <span class="n">reduce</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prev_gear</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InAcceleration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">upshift</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">gear_decr_possible</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prev_Corr4bToBeDoneAfterCorr4a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">twoStepUpshiftInAcceleration</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">twoStepUpshiftInAcceleration</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">twoStepUpshiftInAcceleration</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>

        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># 4.(a) continued :</span>
        <span class="c1"># -----------------------------------------------------------------------</span>
        <span class="c1"># However an upshift by two gears is permitted</span>
        <span class="c1"># at the transition from an acceleration phase to a constant speed phase</span>
        <span class="c1"># if the duration of the constant speed phase exceeds 5 seconds.</span>
        <span class="c1"># -----------------------------------------------------------------------</span>

        <span class="c1"># At a transition from acceleration phase to a constant speed phase longer than 5 seconds :</span>
        <span class="c1"># Decrease a gear, if it differs from the previous non-neutral gear by more than 2 steps.</span>
        <span class="c1"># But assume that this rule must also be applied at other transitions.</span>
        <span class="c1"># At a transition from acceleration phase to a constant speed phase of up to 5 seconds :</span>
        <span class="c1"># Decrease a gear, if it differs from the previous non-neutral gear by more than 1 step..</span>

        <span class="n">prevInAcceleration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InAcceleration</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">next1stInConstantSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InConstantSpeed</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">next2ndInConstantSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next1stInConstantSpeed</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">next3rdInConstantSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next2ndInConstantSpeed</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">next4thInConstantSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next3rdInConstantSpeed</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">next5thInConstantSpeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next4thInConstantSpeed</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">inConstantSpeedMoreThan5Sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">InConstantSpeed</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">inConstantSpeedMoreThan5Sec</span><span class="p">,</span>
            <span class="n">reduce</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InConstantSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">next1stInConstantSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">next2ndInConstantSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">next3rdInConstantSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">next4thInConstantSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">next5thInConstantSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">prev_gear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">upshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">InitialGears</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">gear_decr_possible</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InitialGears</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">minPossibleGears</span><span class="p">)</span>
        <span class="n">tooBigUpshiftAtTransition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">prev_gear</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">tooBigUpshiftAtTransition</span><span class="p">,</span>
            <span class="n">reduce</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prev_gear</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prevInAcceleration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InConstantSpeed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">upshift</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inConstantSpeedMoreThan5Sec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">upshift</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inConstantSpeedMoreThan5Sec</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">gear_decr_possible</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tooBigUpshiftAtTransition</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tooBigUpshiftAtTransition</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tooBigUpshiftAtTransition</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">InitialGears</span></div>


<div class="viewcode-block" id="applyCorrection4c"><a class="viewcode-back" href="../../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.html#gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.applyCorrection4c">[docs]</a><span class="k">def</span> <span class="nf">applyCorrection4c</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">,</span> <span class="n">PossibleGears</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sub-Annex 2 in section 4.(c)</span>

<span class="sd">    If gear i is used for a time sequence of 1 to 5 seconds</span>
<span class="sd">    and the gear prior to this sequence is one step lower</span>
<span class="sd">    and the gear after this sequence is one or two steps lower than within this sequence</span>
<span class="sd">    or the gear prior to this sequence is two steps lower</span>
<span class="sd">    and the gear after this sequence is one step lower than within the sequence,</span>
<span class="sd">    the gear for the sequence shall be corrected to</span>
<span class="sd">    the maximum of the gears before and after the sequence.</span>
<span class="sd">    In all cases i-1 &gt;= i_min shall be fulfilled.</span>

<span class="sd">    .. note:: The corrected gear will be i-1 in all cases. 3.5. Determination of possible</span>
<span class="sd">        gears to be used. The lowest final possible gear is i_min.</span>

<span class="sd">    :param InitialGears:</span>
<span class="sd">        A cell array of gear numbers AFTER the previous correction</span>
<span class="sd">    :type InitialGears: numpy.array</span>

<span class="sd">    :param PossibleGears:</span>
<span class="sd">        The possible gears calculated by each second</span>
<span class="sd">    :type PossibleGears: numpy.array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - InitialGears (:py:class:`numpy.array`):</span>
<span class="sd">            A cell array of gear numbers AFTER the current correction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">minPossibleGears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">PossibleGears</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">PossibleGears</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">d</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)</span> <span class="ow">and</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">d</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span><span class="p">]:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
                <span class="n">maxgears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">[</span><span class="n">ri</span><span class="p">],</span> <span class="n">minPossibleGears</span><span class="p">[</span><span class="n">ri</span><span class="p">])</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxgears</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="ow">and</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">(</span>
                <span class="n">d</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">d</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">maxgears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">[</span><span class="n">ri</span><span class="p">],</span> <span class="n">minPossibleGears</span><span class="p">[</span><span class="n">ri</span><span class="p">])</span> <span class="k">for</span> <span class="n">ri</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxgears</span>

    <span class="k">return</span> <span class="n">InitialGears</span></div>


<div class="viewcode-block" id="applyCorrection4d"><a class="viewcode-back" href="../../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.html#gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.applyCorrection4d">[docs]</a><span class="k">def</span> <span class="nf">applyCorrection4d</span><span class="p">(</span>
    <span class="n">InitialGears</span><span class="p">,</span>
    <span class="n">PhaseStarts</span><span class="p">,</span>
    <span class="n">PhaseEnds</span><span class="p">,</span>
    <span class="n">PhaseValues</span><span class="p">,</span>
    <span class="n">PHASE_DECELERATION</span><span class="p">,</span>
    <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">,</span>
    <span class="n">corr_4d_applied_before</span><span class="p">,</span>
    <span class="n">TraceTimesCount</span><span class="p">,</span>
    <span class="n">NoOfGearsFinal</span><span class="p">,</span>
    <span class="n">RequiredVehicleSpeeds</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Regulation Annex 2, 4.(d) :</span>
<span class="sd">    No upshift to a higher gear shall be performed within a deceleration phase.</span>

<span class="sd">    .. note:: The newest regulation ECE/TRANS/WP.29/GRPE/2019/2 moved the text part below to paragraph Annex 2, 4.(e).</span>
<span class="sd">        But we keep it here as it does not matter whether it will be executed at the end of 4.(d) or at the begin of 4.(e).</span>
<span class="sd">    No upshift to a higher gear at the transition</span>
<span class="sd">    from an acceleration or constant speed phase</span>
<span class="sd">    to a deceleration phase shall be performed</span>
<span class="sd">    if one of the gears in the first two seconds</span>
<span class="sd">    following the end of the deceleration phase</span>
<span class="sd">    is lower than the upshifted gear or is gear 0.</span>
<span class="sd">    If there is an upshift during the transition</span>
<span class="sd">    and the initial deceleration phase by 2 gears,</span>
<span class="sd">    an upshift by 1 gear shall be performed instead.</span>
<span class="sd">    In this case, no further modifications shall be perfomed</span>
<span class="sd">    in the following gear use checks.</span>

<span class="sd">    :param InitialGears:</span>
<span class="sd">        A cell array of gear numbers AFTER the previous correction</span>
<span class="sd">    :type InitialGears: numpy.array</span>

<span class="sd">    :param PhaseStarts:</span>
<span class="sd">        Contains the points that are start point from a phase</span>
<span class="sd">    :type PhaseStarts: numpy.array</span>

<span class="sd">    :param PhaseEnds:</span>
<span class="sd">        Contains the points that are end point from a phase</span>
<span class="sd">    :type PhaseEnds: numpy.array</span>

<span class="sd">    :param PhaseValues:</span>
<span class="sd">        Contains the points of changes phases</span>
<span class="sd">    :type PhaseValues: numpy.array</span>

<span class="sd">    :param PHASE_DECELERATION:</span>
<span class="sd">        time period of more than 2 seconds with required vehicle</span>
<span class="sd">                speed &gt;= 1km/h and monotonically decreasing</span>
<span class="sd">    :type PHASE_DECELERATION: int</span>

<span class="sd">    :param PHASE_DECELERATION_TO_STANDSTILL:</span>
<span class="sd">        DECELERATION phase preceding a STANDSTILL phase</span>
<span class="sd">    :type PHASE_DECELERATION_TO_STANDSTILL: int</span>

<span class="sd">    :param corr_4d_applied_before:</span>
<span class="sd">        Boolean array that check if correction 4d have been applied before as True</span>
<span class="sd">    :type corr_4d_applied_before: boolean numpy.array</span>

<span class="sd">    :param TraceTimesCount:</span>
<span class="sd">        The length of trace times re-sampled in 1Hz</span>
<span class="sd">    :type TraceTimesCount: int</span>

<span class="sd">    :param NoOfGearsFinal:</span>
<span class="sd">        The number of forward gears after apply the exclusion of first gear</span>
<span class="sd">        if is necessary.</span>
<span class="sd">    :type NoOfGearsFinal: int</span>

<span class="sd">    :param RequiredVehicleSpeeds:</span>
<span class="sd">        The vehicle speed required for the whole cycle re-sampled in 1Hz</span>
<span class="sd">    :type RequiredVehicleSpeeds: numpy.array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - InitialGears (:py:class:`numpy.array`):</span>
<span class="sd">            A cell array of gear numbers AFTER the current correction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">AnyDecelerationStarts</span> <span class="o">=</span> <span class="n">PhaseStarts</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">AnyDecelerationEnds</span> <span class="o">=</span> <span class="n">PhaseEnds</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">AnyDecelerations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">AnyDecelerationStarts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AnyDecelerationEnds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">AnyDecelerationStarts</span><span class="p">))</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">AnyDecelerations</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corr_4d_applied_before</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># NOTE:</span>
        <span class="c1"># the phase before a deceleration phase</span>
        <span class="c1"># is guaranteed to be either a acceleration phase or a constant speed phase</span>
        <span class="c1"># because it can neither be a stillstand phase nor another deceleration phase</span>

        <span class="c1"># correction 4a requires that each gear must be used for at least 2 sec during acceleration</span>
        <span class="c1"># this may lead to a delayed usage of higher gears even in the subsequent deceleration phase</span>
        <span class="c1"># so an upshift at the transition from acceleration to deceleration phase</span>
        <span class="c1"># may occur not immediately at the first second of the transition but some seconds later</span>
        <span class="c1"># therefore we will regard any upshift occuring during the first 3 seconds of the deceleration phase</span>
        <span class="c1"># as being related to the transition</span>
        <span class="c1"># eg RRT vehicle 23, trace seconds 605..616 :</span>
        <span class="c1">#   605        616</span>
        <span class="c1">#    v          v</span>
        <span class="c1">#    AAAAAAAAADDD  A:acceleration D:deceleration</span>
        <span class="c1">#    223456677777  g_max</span>
        <span class="c1">#    223344556677  gear corr 4a : use each gear for at least 2 sec</span>
        <span class="c1">#              ^   delayed usage of higher gear after transition A-&gt;D</span>

        <span class="n">g_max_at_transition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase</span><span class="p">))]])</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">g_max_at_transition</span> <span class="o">&gt;</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">phase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">TraceTimesCount</span>
            <span class="ow">and</span> <span class="p">(</span>
                <span class="n">g_max_at_transition</span> <span class="o">&gt;</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="ow">or</span> <span class="n">g_max_at_transition</span> <span class="o">&gt;</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                <span class="ow">or</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">g_max_at_transition</span> <span class="o">-</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># single step upshift</span>
                <span class="c1"># disable upshifts to gears higher than used before decelaration phase</span>
                <span class="n">mingears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">mingears</span>
                <span class="n">corr_4d_applied_before</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">g_max_at_transition</span> <span class="o">-</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                <span class="mi">2</span><span class="p">,</span> <span class="n">NoOfGearsFinal</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="n">mingears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phase</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">mingears</span>
                <span class="n">corr_4d_applied_before</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># no upshift to a higher gear shall be performed within a deceleration phase</span>

        <span class="c1"># but Heinz Steven Tool extends a deceleration phase by a following constant speed second</span>
        <span class="c1"># when handling gear correction &quot;no upshift during decel&quot;</span>
        <span class="c1"># eg for RRT vehicle 20 time 1744</span>
        <span class="c1"># 2019-02-26 found that HST extends a deceleration phase also by a following acceleration second</span>
        <span class="c1"># eg for RRT vehicle 20 time 670 when using n_min_drive_down = 1500</span>

        <span class="n">phase_ext</span> <span class="o">=</span> <span class="n">phase</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">RequiredVehicleSpeeds</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">phase_ext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">RequiredVehicleSpeeds</span><span class="p">[</span><span class="n">phase_ext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span>
                        <span class="n">RequiredVehicleSpeeds</span><span class="p">[[</span><span class="n">phase_ext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phase_ext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">&lt;</span> <span class="mf">0.001</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span>
                    <span class="n">RequiredVehicleSpeeds</span><span class="p">[[</span><span class="n">phase_ext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phase_ext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">phase_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_ext</span><span class="p">,</span> <span class="n">phase_ext</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">gears</span> <span class="o">=</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase_ext</span><span class="p">]</span>
        <span class="n">idx_neutral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gears</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">gears</span><span class="p">[</span><span class="n">idx_neutral</span><span class="p">]</span> <span class="o">=</span> <span class="n">NoOfGearsFinal</span>
        <span class="n">gears</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">_my_cummin</span><span class="p">(</span><span class="n">gears</span><span class="p">))</span>
        <span class="n">gears</span><span class="p">[</span><span class="n">idx_neutral</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">InitialGears</span><span class="p">[</span><span class="n">phase_ext</span><span class="p">]</span> <span class="o">=</span> <span class="n">gears</span>

    <span class="k">return</span> <span class="n">InitialGears</span></div>


<div class="viewcode-block" id="applyCorrection4e"><a class="viewcode-back" href="../../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.html#gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.applyCorrection4e">[docs]</a><span class="k">def</span> <span class="nf">applyCorrection4e</span><span class="p">(</span>
    <span class="n">InitialGears</span><span class="p">,</span>
    <span class="n">PhaseStarts</span><span class="p">,</span>
    <span class="n">PhaseEnds</span><span class="p">,</span>
    <span class="n">PhaseValues</span><span class="p">,</span>
    <span class="n">ClutchDisengaged</span><span class="p">,</span>
    <span class="n">InitialRequiredEngineSpeeds</span><span class="p">,</span>
    <span class="n">IdlingEngineSpeed</span><span class="p">,</span>
    <span class="n">PHASE_DECELERATION</span><span class="p">,</span>
    <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">,</span>
    <span class="n">Phases</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Regulation Annex 2, 4.(e) :</span>

<span class="sd">    .. note:: The newest regulation ECE/TRANS/WP.29/GRPE/2019/2</span>
<span class="sd">        moved this gear correction to paragraph</span>
<span class="sd">        3.3. Selection of possible gears with respect to engine speed.</span>
<span class="sd">        But we keep it here to check also additional usages of gear 2,</span>
<span class="sd">        which may result from other gear corrections done before.</span>

<span class="sd">    During a deceleration phase, gears with n_gear &gt; 2 shall be used</span>
<span class="sd">    as long as the engine speed does not drop below n_min_drive.</span>
<span class="sd">    Gear 2 shall be used during a deceleration phase within a short trip</span>
<span class="sd">    of the cycle (not at the end of a short trip)as long as the engine</span>
<span class="sd">    speed does not drop below (0.9 Ã— n_idle).</span>
<span class="sd">    If the engine speed drops below n_idle, the clutch shall be disengaged.</span>
<span class="sd">    If the deceleration phase is the last part of a short trip shortly before a stop phase,</span>
<span class="sd">    the second gear shall be used as long as the engine speed does not drop below n_idle.</span>

<span class="sd">    :param InitialGears:</span>
<span class="sd">        A cell array of gear numbers AFTER the previous correction</span>
<span class="sd">    :type InitialGears: numpy.array</span>

<span class="sd">    :param PhaseStarts:</span>
<span class="sd">        Contains the points that are start point from a phase</span>
<span class="sd">    :type PhaseStarts: numpy.array</span>

<span class="sd">    :param PhaseEnds:</span>
<span class="sd">        Contains the points that are end point from a phase</span>
<span class="sd">    :type PhaseEnds: numpy.array</span>

<span class="sd">    :param PhaseValues:</span>
<span class="sd">        Contains the points of changes phases</span>
<span class="sd">    :type PhaseValues: numpy.array</span>

<span class="sd">    :param ClutchDisengaged:</span>
<span class="sd">        The clutch disengaged by each second.</span>
<span class="sd">    :type ClutchDisengaged: boolean numpy.array</span>

<span class="sd">    :param InitialRequiredEngineSpeeds:</span>
<span class="sd">        The initial engine speeds required for each gear i from 1 to ng and</span>
<span class="sd">        for each second j of the cycle trace.</span>
<span class="sd">    :type InitialRequiredEngineSpeeds: numpy.array</span>

<span class="sd">    :param IdlingEngineSpeed:</span>
<span class="sd">        Annex 2 (2c) n_idle. The idling speed.</span>
<span class="sd">    :type IdlingEngineSpeed: float</span>

<span class="sd">    :param PHASE_DECELERATION:</span>
<span class="sd">        time period of more than 2 seconds with required vehicle</span>
<span class="sd">                speed &gt;= 1km/h and monotonically decreasing</span>
<span class="sd">    :type PHASE_DECELERATION: int</span>

<span class="sd">    :param PHASE_DECELERATION_TO_STANDSTILL:</span>
<span class="sd">        DECELERATION phase preceding a STANDSTILL phase</span>
<span class="sd">    :type PHASE_DECELERATION_TO_STANDSTILL: int</span>

<span class="sd">    :param Phases:</span>
<span class="sd">        The list of phases that are used during whole cycle</span>
<span class="sd">    :type Phases: numpy.array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - InitialGears (:py:class:`numpy.array`):</span>
<span class="sd">            A cell array of gear numbers AFTER the current correction</span>
<span class="sd">        - ClutchDisengaged (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The clutch disengaged by each second AFTER the current correction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">AnyDecelerationStarts</span> <span class="o">=</span> <span class="n">PhaseStarts</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">AnyDecelerationEnds</span> <span class="o">=</span> <span class="n">PhaseEnds</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PhaseValues</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">AnyDecelerations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">AnyDecelerationStarts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AnyDecelerationEnds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">AnyDecelerationStarts</span><span class="p">))</span>
    <span class="p">]</span>

    <span class="n">secondGearsWithLowEngineSpeeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InitialGears</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InitialRequiredEngineSpeeds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">IdlingEngineSpeed</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phases</span> <span class="o">==</span> <span class="n">PHASE_DECELERATION_TO_STANDSTILL</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InitialRequiredEngineSpeeds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">IdlingEngineSpeed</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">AnyDecelerations</span><span class="p">:</span>
        <span class="n">secondGearsWithLowEngineSpeedsInPhase</span> <span class="o">=</span> <span class="n">secondGearsWithLowEngineSpeeds</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">secondGearsWithLowEngineSpeeds</span> <span class="o">&gt;=</span> <span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">secondGearsWithLowEngineSpeeds</span> <span class="o">&lt;=</span> <span class="n">phase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">secondGearsWithLowEngineSpeedsInPhase</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Additional correction get the same results as the Heinz Steven Tool</span>
        <span class="c1"># (eg for RRT vehicle 8, trace seconds 94:95, 440, 525, 1449, 1792:1793).</span>
        <span class="c1"># HST seems to do gear correction 4f (eg 33322111 -&gt; 33301111)</span>
        <span class="c1"># while Matlab substitutes gear 1 by gear 2 before (eg 33322111 -&gt; 33322222).</span>
        <span class="c1"># To compensate this an additional correction will be done here:</span>
        <span class="c1"># If gear 2 would only be used for 1 or 2 seconds before becomming disengaged</span>
        <span class="c1"># then disengage gear 2 also during this initial seconds.</span>
        <span class="k">if</span> <span class="n">secondGearsWithLowEngineSpeedsInPhase</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t_clutch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">secondGearsWithLowEngineSpeedsInPhase</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">t_clutch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">t_clutch</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">t_clutch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">InitialGears</span><span class="p">[</span><span class="n">t_clutch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
                <span class="ow">and</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">t_clutch</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
                <span class="ow">and</span> <span class="n">InitialGears</span><span class="p">[</span><span class="n">t_clutch</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span>
            <span class="p">):</span>
                <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">t_clutch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">t_clutch</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">ClutchDisengaged</span></div>


<div class="viewcode-block" id="applyCorrection4f"><a class="viewcode-back" href="../../../../../gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.html#gearshift.core.model.calculateShiftpointsNdvFullPC.corrections.applyCorrection4f">[docs]</a><span class="k">def</span> <span class="nf">applyCorrection4f</span><span class="p">(</span>
    <span class="n">InitialGears</span><span class="p">,</span>
    <span class="n">ClutchDisengaged</span><span class="p">,</span>
    <span class="n">SuppressGear0DuringDownshifts</span><span class="p">,</span>
    <span class="n">PossibleGears</span><span class="p">,</span>
    <span class="n">InStandStill</span><span class="p">,</span>
    <span class="n">InDecelerationToStandstill</span><span class="p">,</span>
    <span class="n">InDeceleration</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sub-Annex 2 in section 4.(f)</span>

<span class="sd">    If during a deceleration phase the duration of a gear sequence between</span>
<span class="sd">    two gear sequences of 3 seconds or more is only 1 second, it shall be</span>
<span class="sd">    replaced by gear 0 and the clutch shall be disengaged.</span>

<span class="sd">    :param InitialGears:</span>
<span class="sd">        A cell array of gear numbers AFTER the previous correction</span>
<span class="sd">    :type InitialGears: numpy.array</span>

<span class="sd">    :param ClutchDisengaged:</span>
<span class="sd">        The clutch disengaged by each second.</span>
<span class="sd">    :type ClutchDisengaged: boolean numpy.array</span>

<span class="sd">    :param SuppressGear0DuringDownshifts:</span>
<span class="sd">        Sub-Annex 2 (4f).If a gear is used for only 1 second during a deceleration phase</span>
<span class="sd">        it shall be replaced by gear 0 with clutch disengaged, in order to avoid too high</span>
<span class="sd">        engine speeds. But if this is not an issue, the manufacturer may allow to use the</span>
<span class="sd">        lower gear of the following second directly instead of gear 0 for downshifts of</span>
<span class="sd">        up to 3 steps.</span>
<span class="sd">    :type SuppressGear0DuringDownshifts: bool</span>

<span class="sd">    :param PossibleGears:</span>
<span class="sd">        The possible gears calculated by each second</span>
<span class="sd">    :type PossibleGears: numpy.array</span>

<span class="sd">    :param InStandStill:</span>
<span class="sd">        Contains the points that are in standstill phase as a True</span>
<span class="sd">    :type InStandStill: boolean numpy.array</span>

<span class="sd">    :param InDecelerationToStandstill:</span>
<span class="sd">        The array that contains the seconds from deceleration to standstill as a True</span>
<span class="sd">    :type InDecelerationToStandstill: boolean numpy.array</span>

<span class="sd">    :param InDeceleration:</span>
<span class="sd">        Contains the points that are in deceleration phase as a True</span>
<span class="sd">    :type InDeceleration: boolean array</span>

<span class="sd">    :returns:</span>
<span class="sd">        - InitialGears (:py:class:`numpy.array`):</span>
<span class="sd">            A cell array of gear numbers AFTER the current correction</span>
<span class="sd">        - ClutchDisengaged (:py:class:`boolean numpy.array`):</span>
<span class="sd">            The clutch disengaged by each second AFTER the current correction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

    <span class="n">gear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">InitialGears</span><span class="p">)</span>
    <span class="n">i_max</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gear</span><span class="p">)</span>

    <span class="n">gear_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">PossibleGears</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">PossibleGears</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">InStandStillExtended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">InStandStill</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i_max</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">InStandStillExtended</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">InStandStillExtended</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_max</span><span class="p">):</span>
        <span class="c1"># NOTE:</span>
        <span class="c1"># In the gear sequence examples shown by the regulation text</span>
        <span class="c1"># eg &quot;j, 0, i, i, i-1, k&quot;</span>
        <span class="c1"># the letters &quot;i&quot;, &quot;j&quot; and &quot;k&quot; denote gear NUMBERS.</span>
        <span class="c1"># But in this for-loop the letter &quot;i&quot; is the time INDEX of the gear</span>
        <span class="c1"># which possibly will be replaced by gear 0.</span>
        <span class="c1"># So the time indices for the regulation example above are i-1:i+4</span>
        <span class="c1"># and the related gear numbers are defined by gear(i-1:i+4).</span>

        <span class="n">replaced</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Heinz Steven Tool 2019-10-08 corrects the gear sequence</span>
        <span class="c1"># for vehicle 114 time 434..443</span>
        <span class="c1"># from 5 5 5 4 4 3 2 0 0 0</span>
        <span class="c1"># to   5 5 5 0 0 0 0 0 0 0</span>
        <span class="c1"># while it should have been corrected</span>
        <span class="c1"># to   5 5 5 0 2 2 2 0 0 0</span>
        <span class="c1"># So we correct such exceptional gear sequences like Heinz Steven.</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
            <span class="ow">and</span> <span class="n">InDecelerationToStandstill</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># Regulation Annex 2, 4.(f) :</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># If during a deceleration phase the duration of a gear sequence</span>
        <span class="c1"># (a time sequence with constant gear)</span>
        <span class="c1"># between two gear sequences of 3 seconds or more</span>
        <span class="c1"># is only 1 second,</span>
        <span class="c1"># it shall be replaced by gear 0 and &quot;the clutch shall be disengaged.</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># NOTE: Another text later was moved to the begin of regulation 4.(f).</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">i</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
            <span class="ow">and</span> <span class="n">InDeceleration</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">replaced</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># If during a deceleration phase the duration of a gear period</span>
        <span class="c1"># (a time sequence with constant gear)</span>
        <span class="c1"># between two gear sequences of 3 seconds or more</span>
        <span class="c1"># is 2 seconds,</span>
        <span class="c1"># it shall be replaced by gear 0 for the 1st second</span>
        <span class="c1"># and for the 2nd second with the gear</span>
        <span class="c1"># that follows after the 2 second period.</span>
        <span class="c1"># The clutch shall be disengaged for the 1st second.</span>
        <span class="c1"># This requirement shall only be applied</span>
        <span class="c1"># if the gear that follows after the 2 second period is &gt; 0.</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">i</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
            <span class="ow">and</span> <span class="n">InDeceleration</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">replaced</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># If several gear sequences with durations of 1 or 2 seconds</span>
        <span class="c1"># follow one another, corrections shall be performed as follows:</span>
        <span class="c1"># -------------------------------------------------------------------</span>

        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># A gear sequence</span>
        <span class="c1">#       i, i, i, i-1, i-1, i-2  or</span>
        <span class="c1">#       i, i, i, i-1, i-2, i-2</span>
        <span class="c1"># shall be changed to</span>
        <span class="c1">#   ==&gt; i, i, i,   0, i-2, i-2</span>
        <span class="c1"># with i-2 &gt; 0</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">i</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
            <span class="ow">and</span> <span class="n">InDeceleration</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="ow">and</span> <span class="p">(</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                <span class="ow">or</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">replaced</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># A gear sequence such as</span>
        <span class="c1">#       i, i, i, i-1, i-2, i-3  or</span>
        <span class="c1">#       i, i, i, i-2, i-2, i-3  or</span>
        <span class="c1">#       other possible combinations</span>
        <span class="c1"># shall be changed to</span>
        <span class="c1">#   ==&gt; i, i, i,   0, i-3, i-3</span>
        <span class="c1"># with i-3 &gt; 0</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># what are &quot;other possible combinations&quot; ?</span>
        <span class="c1"># found that HST for RRT vehicle 32 time 1529:1534 replaces also</span>
        <span class="c1"># 6 6 6 5 2 2 -&gt; 6 6 6 0 2 2 2</span>
        <span class="c1"># so also following correction must also be done :</span>
        <span class="c1">#       i, i, i, i-1, i-4, i-4</span>
        <span class="c1"># shall be changed to</span>
        <span class="c1">#   ==&gt; i, i, i,   0, i-4, i-4</span>
        <span class="c1"># assume following generalization :</span>
        <span class="c1"># - the last three gears must not be increasing</span>
        <span class="c1"># - the last gear must be three or more steps below first gear (i)</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">i</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
            <span class="ow">and</span> <span class="n">InDeceleration</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">replaced</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># This change shall also be applied to gear sequences</span>
        <span class="c1"># where the acceleration is &gt;= 0 for the first 2 seconds</span>
        <span class="c1"># and &lt; 0 for the 3rd second</span>
        <span class="c1"># or where the acceleration is &gt;= 0 for the last 2 seconds.</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># IMPLEMENTED ABOVE AS: all( InDeceleration( i-1 : i ) )</span>
        <span class="c1"># -------------------------------------------------------------------</span>

        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># In all cases specified above in this sub-paragraph,</span>
        <span class="c1"># the clutch disengagement (gear 0) for 1 second is used</span>
        <span class="c1"># in order to avoid too high engine speeds for this second.</span>
        <span class="c1"># If this is not an issue and, if requested by the manufacturer,</span>
        <span class="c1"># it is allowed to use the lower gear of the following second</span>
        <span class="c1"># directly instead of gear 0 for downshifts of up to 3 steps.</span>
        <span class="c1"># The use of this option shall be recorded.</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># NOTE: This text is a later part of the regulation text.</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">replaced</span>
            <span class="ow">and</span> <span class="n">SuppressGear0DuringDownshifts</span>
            <span class="ow">and</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">replaced</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># For extreme transmission designs, it is possible</span>
        <span class="c1"># that gear sequences with durations of 1 or 2 seconds</span>
        <span class="c1"># following one another may last up to 7 seconds.</span>
        <span class="c1"># In such cases, the correction above shall be complemented</span>
        <span class="c1"># by the following correction requirements in a second step:</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># NOTE: This text is a earlier part of the regulation text.</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">replaced</span><span class="p">:</span>
            <span class="c1"># ---------------------------------------------------------------</span>
            <span class="c1"># If gear i-1 is one or two steps below i_max</span>
            <span class="c1"># for second 3 of this sequence (one after gear 0).</span>
            <span class="c1"># A gear sequence shall be changed :</span>
            <span class="c1">#       j, 0, i  , i  , i-1, k</span>
            <span class="c1">#   ==&gt; j, 0, i-1, i-1, i-1, k</span>
            <span class="c1">#       with j &gt; i+1 and 0 &lt; k &lt;= i-1</span>
            <span class="c1"># ---------------------------------------------------------------</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">gear_max</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>

            <span class="c1"># ---------------------------------------------------------------</span>
            <span class="c1"># If gear i-1 is more than two steps below i_max</span>
            <span class="c1"># for second 3 of this sequence</span>
            <span class="c1"># A gear sequence shall be changed :</span>
            <span class="c1">#       j, 0, i  , i  , i-1, k</span>
            <span class="c1">#   ==&gt; j, 0, 0  , k  , k  , k</span>
            <span class="c1">#       with j &gt; i+1 and 0 &lt; k &lt;= i-1</span>
            <span class="c1"># ---------------------------------------------------------------</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">gear_max</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>

            <span class="c1"># ---------------------------------------------------------------</span>
            <span class="c1"># If gear i-2 is one or two steps below i_max</span>
            <span class="c1"># for second 3 of this sequence (one after gear 0).</span>
            <span class="c1"># A gear sequence shall be changed :</span>
            <span class="c1">#       j, 0, i  , i  , i-2, k</span>
            <span class="c1">#   ==&gt; j, 0, i-2, i-2, i-2, k</span>
            <span class="c1">#       with j &gt; i+1 and 0 &lt; k &lt;= i-2</span>
            <span class="c1"># ---------------------------------------------------------------</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">gear_max</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>

            <span class="c1"># ---------------------------------------------------------------</span>
            <span class="c1"># If gear i-2 is more than two steps below i_max</span>
            <span class="c1"># for second 3 of this sequence,</span>
            <span class="c1">#       j, 0, i  , i  , i-2, k</span>
            <span class="c1">#   ==&gt; j, 0, 0  , k  , k  , k</span>
            <span class="c1">#       with j &gt; i+1 and 0 &lt; k &lt;= i-2</span>
            <span class="c1"># ---------------------------------------------------------------</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">gear_max</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>
                <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>

        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># If the deceleration phase is the last part of a short trip</span>
        <span class="c1"># shortly before a stop phase</span>
        <span class="c1"># and the last gear &gt; 0 before the stop phase</span>
        <span class="c1"># is used only for a period of up to 2 seconds,</span>
        <span class="c1"># gear 0 shall be used instead</span>
        <span class="c1"># and the gear lever shall be placed in neutral</span>
        <span class="c1"># and the clutch shall be engaged.</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="c1"># NOTE: This text later was moved to the begin of regulation 4.(f).</span>
        <span class="c1"># -------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
            <span class="ow">and</span> <span class="n">InDecelerationToStandstill</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">InStandStillExtended</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="c1"># decelaration to standstill with last non-zero gear used for 1 second</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">i_max</span>
            <span class="ow">and</span> <span class="n">InDecelerationToStandstill</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">InStandStillExtended</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="c1"># decelaration to standstill with last non-zero gear used for 2 seconds</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">gear</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># -----------------------------------------------------------------------</span>
    <span class="c1"># A downshift to first gear is not permitted</span>
    <span class="c1"># during those deceleration phases.</span>
    <span class="c1"># If such a downshift would be necessary</span>
    <span class="c1"># in the last part of a short trip just before a stop phase,</span>
    <span class="c1"># since the engine speed would drop below n_idle in 2nd gear,</span>
    <span class="c1"># gear 0 shall be used instead</span>
    <span class="c1"># and the gear lever shall be placed in neutral</span>
    <span class="c1"># and the clutch shall be engaged.</span>
    <span class="c1">#</span>
    <span class="c1"># If the first gear is required in a time oeriod of the least 2 seconds</span>
    <span class="c1"># imemdiately before of a deceleration to stop,</span>
    <span class="c1"># this gear should be used until the first sample of the deceleration phase.</span>
    <span class="c1"># For the rest of the deceleration phase,</span>
    <span class="c1"># gear 0 shall be used and the gear lever shall be placed in neutral</span>
    <span class="c1"># and the clutch shall be engaged.</span>
    <span class="c1"># -----------------------------------------------------------------------</span>
    <span class="c1"># NOTE: This text later was moved to an earlier position of regulation 4.(f).</span>
    <span class="c1"># -----------------------------------------------------------------------</span>
    <span class="n">InDecelerationToStandstillPrev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">InDecelerationToStandstill</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">gear</span><span class="p">,</span>
        <span class="n">reduce</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationToStandstillPrev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationToStandstill</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gear</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">gearPrev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">gear</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># additional correction required for eg :</span>
    <span class="c1"># - HST vehicle_no: 109 time: 1446</span>
    <span class="c1"># - HST vehicle_no: 111 time: 1446</span>
    <span class="n">BeginDecelerationToStandstillGear1Engaged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">InDecelerationToStandstillPrev</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">BeginDecelerationToStandstillGear1Engaged</span><span class="p">,</span>
        <span class="n">reduce</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationToStandstillPrev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gearPrev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationToStandstill</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gear</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ClutchDisengaged</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">gear</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BeginDecelerationToStandstillGear1Engaged</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ClutchDisengaged</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BeginDecelerationToStandstillGear1Engaged</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># If gear 0 with disengaged clutch was inserted by above gear corrections</span>
    <span class="c1"># then futher gear corrections may have lead to an immediately</span>
    <span class="c1"># following gear 0 with engaged clutch.</span>
    <span class="c1"># In this cases the clutch shall already be engaged for the inserted gear 0.</span>
    <span class="n">InDecelerationToStandstillNext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">InDecelerationToStandstill</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">gearNext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gear</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ClutchDisengagedNext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ClutchDisengaged</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
        <span class="n">ClutchDisengaged</span><span class="p">,</span>
        <span class="n">reduce</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationToStandstill</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">InDecelerationToStandstillNext</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gear</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gearNext</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ClutchDisengaged</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ClutchDisengagedNext</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">InitialGears</span> <span class="o">=</span> <span class="n">gear</span>

    <span class="k">return</span> <span class="n">InitialGears</span><span class="p">,</span> <span class="n">ClutchDisengaged</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2015-2019, European Commission (JRC)

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>